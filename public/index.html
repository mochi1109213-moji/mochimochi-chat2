<!DOCTYPE html>
<html>
<head>
    <title>Mochi Chat Pro - Final</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #7494c0; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #messages { list-style-type: none; margin: 0; padding: 20px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* å¹ãå‡ºã—ã®åŸºæœ¬æ§‹é€  */
        .msg-item { margin-bottom: 15px; display: flex; flex-direction: column; max-width: 85%; position: relative; }
        .name { font-size: 0.8em; color: white; margin-bottom: 3px; }
        .bubble-container { display: flex; align-items: flex-end; gap: 5px; }
        .msg-text { padding: 10px 14px; border-radius: 18px; font-size: 15px; word-wrap: break-word; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .time { font-size: 0.65em; color: #eee; min-width: 40px; }

        /* æ—¢èª­æ•°è¡¨ç¤ºï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸­å¤®å´ã«é…ç½®ï¼‰ */
        .read-status { font-size: 0.7em; color: #d1ffc4; font-weight: bold; margin: 0 2px; }

        /* è‡ªåˆ†ï¼ˆå³å´ãƒ»ç·‘ï¼‰ */
        .mine { align-self: flex-end; }
        .mine .bubble-container { flex-direction: row-reverse; }
        .mine .msg-text { background-color: #8de055; border-top-right-radius: 2px; }
        
        /* ä»–äººï¼ˆå·¦å´ãƒ»ç™½ï¼‰ */
        .others { align-self: flex-start; }
        .others .msg-text { background-color: white; border-top-left-radius: 2px; }

        /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
        .reaction-badge { position: absolute; bottom: -8px; right: 10px; background: white; border-radius: 10px; padding: 1px 5px; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid #ddd; }

        /* é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        #context-menu { display: none; position: fixed; background: #333; color: white; border-radius: 12px; padding: 5px 0; z-index: 1000; min-width: 140px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .menu-item { padding: 12px 16px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #444; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: #555; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        #form-container { background: white; padding: 10px; border-top: 1px solid #ddd; padding-bottom: 25px; }
        #reply-preview { display: none; padding: 8px; background: #f0f0f0; font-size: 12px; border-left: 4px solid #8de055; margin-bottom: 8px; border-radius: 4px; }
        #form { display: flex; gap: 8px; align-items: center; }
        #input { flex-grow: 1; border: 1px solid #ccc; padding: 12px; border-radius: 25px; outline: none; font-size: 16px; }
        #send { border: none; background: #8de055; color: #333; width: 60px; height: 40px; border-radius: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <ul id="messages"></ul>
    
    <div id="context-menu"></div>

    <div id="form-container">
        <div id="reply-preview"></div>
        <form id="form">
            <input id="input" autocomplete="off" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." /><button id="send">é€ä¿¡</button>
        </form>
    </div>

    <script>
        var socket = io();
        var selectedMsgId = null;
        var longPressTimer;
        var replyToId = null;

        // åå‰è¨­å®šï¼ˆä¸€åº¦å…¥åŠ›ã™ã‚‹ã¨ä¿å­˜ã•ã‚Œã¾ã™ï¼‰
        var myName = localStorage.getItem('chat-name') || prompt("ãƒãƒ£ãƒƒãƒˆã§ä½¿ã†åå‰ã‚’å…¥åŠ›ã—ã¦ã­") || "ãªãªã—";
        localStorage.setItem('chat-name', myName);

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function addMessage(data) {
            var item = document.createElement('li');
            item.className = `msg-item ${data.name === myName ? 'mine' : 'others'}`;
            item.setAttribute('data-id', data.id);
            item.setAttribute('data-readers', data.readers || 'ã¾ã èª°ã‚‚èª­ã‚“ã§ã„ã¾ã›ã‚“');

            const readText = data.readCount > 0 ? `æ—¢èª­ ${data.readCount}` : '';

            item.innerHTML = `
                <div class="name">${data.name}</div>
                <div class="bubble-container">
                    <div class="msg-text">${data.message}</div>
                    <div class="read-status">${readText}</div>
                    <div class="time">${data.time}</div>
                </div>
                ${data.reaction ? `<div class="reaction-badge">${data.reaction}</div>` : ''}
            `;

            // ã‚¹ãƒãƒ›ãƒ»PCä¸¡å¯¾å¿œã®é•·æŠ¼ã—ã‚¤ãƒ™ãƒ³ãƒˆ
            item.addEventListener('touchstart', (e) => startPress(e, data.id, data.name === myName));
            item.addEventListener('mousedown', (e) => startPress(e, data.id, data.name === myName));
            item.addEventListener('touchend', cancelPress);
            item.addEventListener('mouseup', cancelPress);

            document.getElementById('messages').appendChild(item);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;

            // ä»–äººã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã‚‰è‡ªå‹•ã§ã€Œæ—¢èª­ã€ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹
            if (data.name !== myName) {
                socket.emit('mark as read', { id: data.id, userName: myName });
            }
        }

        // --- é•·æŠ¼ã—å‡¦ç† ---
        function startPress(e, id, isMine) {
            const x = e.pageX || (e.touches ? e.touches[0].pageX : 0);
            const y = e.pageY || (e.touches ? e.touches[0].pageY : 0);
            longPressTimer = setTimeout(() => showMenu(id, isMine, x, y), 600);
        }
        function cancelPress() { clearTimeout(longPressTimer); }

        function showMenu(id, isMine, x, y) {
            selectedMsgId = id;
            var readers = document.querySelector(`li[data-id="${id}"]`).getAttribute('data-readers');
            var menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = Math.min(x, window.innerWidth - 150) + 'px';
            menu.style.top = Math.min(y, window.innerHeight - 200) + 'px';

            let html = `<div class="menu-item" onclick="alert('æ—¢èª­è€…ãƒªã‚¹ãƒˆ:\\n${readers}')">æ—¢èª­è€…ã‚’ç¢ºèª</div>`;
            html += `<div class="menu-item" onclick="setReply()">ãƒªãƒ—ãƒ©ã‚¤</div>`;
            
            if (isMine) {
                html += `<div class="menu-item" onclick="deleteMsg()" style="color:#ff5555;">é€ä¿¡å–ã‚Šæ¶ˆã—</div>`;
            } else {
                html += `<div class="menu-item" onclick="sendReaction('ğŸ‘')">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ğŸ‘</div>`;
            }
            menu.innerHTML = html;
        }

        function closeMenu() { document.getElementById('context-menu').style.display = 'none'; }
        document.addEventListener('click', closeMenu);

        // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•° ---
        function deleteMsg() { socket.emit('delete message', selectedMsgId); }
        function sendReaction(emoji) { socket.emit('reaction', { id: selectedMsgId, emoji: emoji }); }
        function setReply() {
            replyToId = selectedMsgId;
            const preview = document.getElementById('reply-preview');
            preview.style.display = 'block';
            preview.innerText = 'ãƒªãƒ—ãƒ©ã‚¤ã‚’é€ä¿¡ä¸­... (é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰è§£é™¤ä¸å¯)';
        }

        // --- é€šä¿¡å‡¦ç† ---
        document.getElementById('form').addEventListener('submit', function(e) {
            e.preventDefault();
            var input = document.getElementById('input');
            if (input.value) {
                socket.emit('chat message', {
                    name: myName,
                    message: input.value,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });
                input.value = '';
                document.getElementById('reply-preview').style.display = 'none';
                replyToId = null;
            }
        });

        socket.on('chat message', addMessage);
        socket.on('delete message', id => document.querySelector(`li[data-id="${id}"]`)?.remove());
        socket.on('update reaction', data => location.reload()); // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ã¯ç°¡æ˜“çš„ã«ãƒªãƒ­ãƒ¼ãƒ‰
        socket.on('update read', data => {
            const el = document.querySelector(`li[data-id="${data.id}"]`);
            if (el) {
                const status = el.querySelector('.read-status');
                status.innerText = `æ—¢èª­ ${data.count}`;
                el.setAttribute('data-readers', data.readers);
            }
        });
    </script>
</body>
</html>
